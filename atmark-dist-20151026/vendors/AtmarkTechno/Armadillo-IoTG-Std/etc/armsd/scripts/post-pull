#!/bin/sh

apply_line_conf() {
	. /etc/armsd/line.conf

	if [ x"$VERSION" != x"1" ];then
		echo "invalid config version: $VERSION" > /dev/stderr
		exit 1
	fi

	cat > /etc/network/interfaces <<-EOF
	auto lo
	iface lo inet loopback
	EOF
	ifup lo

	echo "# generated by /etc/armsd/scrpts/post-pull" > /etc/armsd/dhcp.conf

	if [ x"$interface_eth0" = x"enable" ]; then
		echo "interface_eth0_metric=$interface_eth0_metric" \
		    >> /etc/armsd/dhcp.conf
		cat >> /etc/network/interfaces <<-EOF
		auto eth0
		iface eth0 inet $interface_eth0_address
			udhcpc_opts -s /etc/armsd/udhcpc.script
		EOF
		ifup eth0
	fi

	if [ x"$interface_3g" = x"enable" ]; then
		3g-set-ap "$interface_3g_apn" "$interface_3g_ppp_id" \
		    "$interface_3g_ppp_pass"
		3g-connect
		echo "interface_3g_metric=$interface_3g_metric" \
		    >> /etc/armsd/dhcp.conf
		cat >> /etc/network/interfaces <<-EOF
		iface umts0 inet $interface_3g_address
			udhcpc_opts -s /etc/armsd/udhcpc.script
		EOF
		ifup umts0
	fi
	return 0
}

# save Location-Config Cache
cp /etc/armsd/armsd.cache /etc/config/armsd.cache
/bin/flatfsd -s 2> /dev/null

# module 0: line configuration
apply_line_conf

# module 1: lighttpd
/usr/sbin/lighttpd -f /etc/lighttpd.conf

# clear status
rm -f /etc/armsd/addr_changed

exit 0
